<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Code Workspace</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- CDNs -->
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  
  <!-- Fabric.js (Canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

</head>
<body>

  <!-- Left Sidebar (Code Selection) -->
  <aside class="left-sidebar">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <span>JOGO RAG</span>
    </div>

    {% if user %}
      <div style="margin: 10px 0 18px 0; font-size: 0.9rem; color: #cfcfcf;">
        <div style="opacity: 0.9;">Signed in as</div>
        <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
          {{ user.get('name') }}
        </div>
      </div>
    {% endif %}

    <label for="category">Code Type</label>
    <select id="category">
      <option value="" selected disabled>Select...</option>
      <!-- Populated by JS -->
    </select>

    <label for="year">Year</label>
    <select id="year" disabled>
      <option value="" selected disabled>Select Code Type first</option>
    </select>

    <label for="doc_id">Document</label>
    <select id="doc_id" disabled>
      <option value="" selected disabled>Select Year first</option>
    </select>

    <div style="flex: 1"></div>
    <div style="margin-top: 20px;">
        <a href="{{ url_for('domain_expansion') }}" target="_blank" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">
            Domain Expansion ‚Üó
        </a>
    </div>
  </aside>

  <main>
    <header>
      <div class="question-box">
        <textarea id="question" placeholder="Ask a question about the selected code..."></textarea>
        <button id="ask-btn" disabled>Ask</button>
      </div>
    </header>

    <div class="workspace">
      <!-- Column 1: Chat + Thought Bubble -->
      <div class="col-left">
        <!-- Chat Section (Top 25%) -->
        <div class="chat-panel">
          <div class="chat-header">
            <span>Answer Stream</span>
            <button id="clear-chat" style="background:none; border:none; color:var(--accent-color); cursor:pointer;">Clear</button>
          </div>
          <div class="chat-body" id="chat-container">
            <div style="color: #999; text-align: center; margin-top: 20px;">
              Answers will appear here.
            </div>
          </div>
        </div>

        <!-- Thought Bubble Section (Bottom 75%) -->
        <div class="thought-bubble-panel">
          <div class="tb-header">
            <span>Thought Bubble</span>
            <div class="tb-tools">
                <!-- Only basic manipulation tools for Thought Bubble -->
                <button id="tb-clear" title="Clear Canvas">üóëÔ∏è</button>
                <button id="tb-download" title="Download PNG">üíæ</button>
                <!-- Removed Editing Tools: Draw, Text, Rect, Circle, Note, etc. -->
            </div>
          </div>
          <div class="tb-canvas-container" id="canvas-container">
             <canvas id="thought-bubble-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Column 2: Document Viewer (Middle) -->
      <div class="col-middle">
        <div class="doc-header">
          <span id="pdf-doc-label">No Document Selected</span>
          <div class="pdf-controls">
            <button id="prev-page">‚óÄ</button>
            <span id="page-indicator" contenteditable="true">1</span> / <span id="total-pages">--</span>
            <button id="next-page">‚ñ∂</button>
            <button id="snippet-tool-btn" title="Snippet Tool">‚úÇÔ∏è</button>
          </div>
        </div>
        <div class="doc-body" id="pdf-wrapper">
           <div id="selection-overlay"></div>
           <div id="pdf-render-container">
             <div style="color: #666; margin-top: 50px;">Select a document to view</div>
           </div>
        </div>
      </div>

      <!-- Column 3: Bookmarks & Snippets (Right) -->
      <div class="col-right">
        <!-- Relevant Pages -->
        <div class="bm-section-top">
          <div class="bm-header">Relevant Pages</div>
          <div class="bm-list" id="page-links-list">
             <div style="padding: 10px; color: #666; font-size: 0.9rem;">
                Ask a question to find pages.
             </div>
          </div>
        </div>

        <!-- Saved Snippets / Folders -->
        <div class="bm-section-bottom">
          <div class="bm-header">
             <span>Saved Snippets</span>
             <button id="create-folder-btn" title="New Folder" style="background:none; border:none; color: #fff; cursor: pointer;">üìÇ+</button>
          </div>
          <div style="padding: 5px 10px;">
             <input type="text" id="new-folder-name" placeholder="New Folder Name..." style="width: 100%; background: #333; border: 1px solid #444; color: #ddd; padding: 4px; border-radius: 4px;">
          </div>
          <div class="bm-list" id="bookmarks-container">
             <!-- Populated by bookmarks.js -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Pass Python Data to JS -->
  <script>
    const HIERARCHY = {{ hierarchy | tojson }};
  </script>

  <!-- Application Scripts -->
  <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
  <script src="{{ url_for('static', filename='js/pdf_viewer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bookmarks.js') }}"></script>
  <script src="{{ url_for('static', filename='js/thought_bubble.js') }}"></script>

  <!-- Dropdown Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const catSelect = document.getElementById('category');
        const yearSelect = document.getElementById('year');
        const docSelect = document.getElementById('doc_id');

        // Populate Categories
        const categories = Object.keys(HIERARCHY);
        categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            catSelect.appendChild(opt);
        });

        // Handle Category Change
        catSelect.addEventListener('change', () => {
            const cat = catSelect.value;
            yearSelect.innerHTML = '<option value="" selected disabled>Select...</option>';
            docSelect.innerHTML = '<option value="" selected disabled>Select Year first</option>';
            docSelect.disabled = true;

            if (cat && HIERARCHY[cat]) {
                const years = Object.keys(HIERARCHY[cat]);
                years.forEach(year => {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    yearSelect.appendChild(opt);
                });
                yearSelect.disabled = false;
            }
        });

        // Handle Year Change
        yearSelect.addEventListener('change', () => {
            const cat = catSelect.value;
            const year = yearSelect.value;
            docSelect.innerHTML = '<option value="" selected disabled>Select...</option>';

            if (cat && year && HIERARCHY[cat][year]) {
                const docs = HIERARCHY[cat][year];
                docs.forEach(doc => {
                    const opt = document.createElement('option');
                    // Value is the doc_id used by backend
                    opt.value = doc.doc_id; 
                    opt.textContent = doc.name;
                    docSelect.appendChild(opt);
                });
                docSelect.disabled = false;
            }
        });
    });
  </script>
</body>
</html>
