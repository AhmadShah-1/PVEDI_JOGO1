<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Code Workspace</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- CDNs -->
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  
  <!-- Fabric.js (Canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

</head>
<body>

  <!-- Left Sidebar (Code Selection) -->
  <aside class="left-sidebar">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <span>JOGO RAG</span>
    </div>

    {% if current_user %}
      <div style="margin: 10px 0 18px 0; font-size: 0.9rem; color: #cfcfcf;">
        <div style="opacity: 0.9;">Signed in as</div>
        <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
          {{ current_user.email }}
        </div>
        <div style="margin-top: 8px;">
          <a href="{{ url_for('auth.logout') }}" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">
            Sign out
          </a>
        </div>
      </div>
    {% endif %}

    <label for="category">Code Type</label>
    <select id="category">
      <option value="" selected disabled>Select...</option>
      {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
      {% endfor %}
    </select>

    <label for="year">Year</label>
    <select id="year" disabled>
      <option value="" selected disabled>Select Code Type first</option>
    </select>

    <label for="doc_id">Document</label>
    <select id="doc_id" disabled>
      <option value="" selected disabled>Select Year first</option>
    </select>

    <div style="flex: 1"></div>
    <div style="margin-top: 20px;">
        <a href="{{ url_for('domain_expansion') }}" target="_blank" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">
            Domain Expansion ↗
        </a>
    </div>
  </aside>

  <main>
    <header>
      <div class="question-box">
        <textarea id="question" placeholder="Ask a question about the selected code..."></textarea>
        <button id="ask-btn" disabled>Ask</button>
      </div>
    </header>

    <div class="workspace">
      <!-- Column 1: Chat + Thought Bubble -->
      <div class="col-left">
        <!-- Chat Section (Top 25%) -->
        <div class="chat-panel">
          <div class="chat-header">
            <span>Answer Stream</span>
            <button id="clear-chat" style="background:none; border:none; color:var(--accent-color); cursor:pointer;">Clear</button>
          </div>
          <div class="chat-body" id="chat-container">
            <div style="color: #999; text-align: center; margin-top: 20px;">
              Answers will appear here.
            </div>
          </div>
        </div>

        <!-- Thought Bubble Section (Bottom 75%) -->
        <div class="thought-bubble-panel">
            <div class="tb-toolbar">
                <span style="margin-right: auto; font-weight: bold; padding-left: 10px; align-self: center;">Thought Bubble</span>
                <button id="tb-download">Download PNG</button>
                <button id="tb-clear">Clear Canvas</button>
            </div>
            <div class="canvas-container" id="canvas-container">
                <canvas id="thought-bubble-canvas"></canvas>
            </div>
        </div>
      </div>

      <!-- Column 2: PDF Viewer -->
      <div class="col-middle">
        <div class="pdf-toolbar">
            <span id="pdf-doc-label">No Document</span>
            <div style="flex:1"></div>
            <button id="prev-page">Prev</button>

            <span contenteditable="true" id="page-indicator">1</span> / 
            <span id="total-pages">0</span>
            <!-- <span id="page-indicator">0 / 0</span> -->

            <button id="next-page">Next</button>
            <div style="width: 20px"></div>
            <button id="snippet-tool-btn" title="Snippet Tool (Draw Box)">✂ Snippet</button>
        </div>
        
        <div id="pdf-wrapper">
             <div id="selection-overlay"></div>
             <!-- PDF Canvas(es) rendered here by JS -->
             <div id="pdf-render-container"></div>
        </div>
      </div>

      <!-- Column 3: Bookmarks -->
      <div class="col-right">
        <!-- Page Links (Top 40%) -->
        <div class="bm-section-top" id="page-links-container">
            <div class="bm-header">Page Links</div>
            <div id="page-links-list" style="color: #999; font-size: 0.9rem;">No active answer.</div>
        </div>

        <!-- Bookmarks & Folders (Bottom 60%) -->
        <div class="bm-section-bottom">
            <div class="bm-header">Bookmarks (BMs)</div>
            
            <div class="folder-input">
                <input type="text" id="new-folder-name" placeholder="New Folder Name">
                <button id="create-folder-btn">+</button>
            </div>

            <div id="bookmarks-container">
                <!-- Folders and Snippets go here -->
            </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modular Scripts -->
  <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
  <script src="{{ url_for('static', filename='js/pdf_viewer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bookmarks.js') }}"></script>
  <script src="{{ url_for('static', filename='js/thought_bubble.js') }}"></script>

  <script>
    // Logic to load documents into the sidebar (Left Sidebar)
    const categorySelect = document.getElementById('category');
    const yearSelect = document.getElementById('year');
    const docSelect = document.getElementById('doc_id');

    // 1. Load Years when Category changes
    categorySelect.addEventListener('change', async () => {
      const category = categorySelect.value;
      
      // Reset dependent dropdowns
      yearSelect.disabled = true;
      yearSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
      
      docSelect.disabled = true;
      docSelect.innerHTML = '<option value="" disabled selected>Select Year first</option>';

      try {
        const res = await fetch(`/years?category=${encodeURIComponent(category)}`);
        const years = await res.json();

        yearSelect.innerHTML = '';
        if (!years.length) {
          yearSelect.innerHTML = '<option value="" disabled selected>No years found</option>';
        } else {
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.disabled = true;
          placeholder.selected = true;
          placeholder.textContent = 'Select a year';
          yearSelect.appendChild(placeholder);

          years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
          });
          yearSelect.disabled = false;
        }
      } catch (err) {
        console.error(err);
        yearSelect.innerHTML = '<option value="" disabled selected>Error loading years</option>';
      }
    });

    // 2. Load Documents when Year changes
    yearSelect.addEventListener('change', async () => {
      const category = categorySelect.value;
      const year = yearSelect.value;

      docSelect.disabled = true;
      docSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

      try {
        const res = await fetch(`/docs?category=${encodeURIComponent(category)}&year=${encodeURIComponent(year)}`);
        const docs = await res.json();

        docSelect.innerHTML = '';
        if (!docs.length) {
          docSelect.innerHTML = '<option value="" disabled selected>No documents found</option>';
        } else {
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.disabled = true;
          placeholder.selected = true;
          placeholder.textContent = 'Select a document';
          docSelect.appendChild(placeholder);

          docs.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.label;
            docSelect.appendChild(opt);
          });
          docSelect.disabled = false;
        }
      } catch (err) {
        console.error(err);
        docSelect.innerHTML = '<option value="" disabled selected>Error loading docs</option>';
      }
    });
  </script>
</body>
</html>
