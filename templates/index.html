<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Code Workspace</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- CDNs -->
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  
  <!-- Fabric.js (Canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

</head>
<body>

  <!-- Left Sidebar (Code Selection) -->
  <aside class="left-sidebar">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <span>JOGO RAG</span>
    </div>

    {% if user %}
      <div style="margin: 10px 0 18px 0; font-size: 0.9rem; color: #cfcfcf;">
        <div style="opacity: 0.9;">Signed in as</div>
        <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
          {{ user.get('name') }}
        </div>
      </div>
    {% endif %}

    <label>Document Browser</label>
    
    <!-- Breadcrumb Navigation -->
    <div id="breadcrumb" class="breadcrumb">
      <span class="breadcrumb-item" data-path="Codes/">üìÅ Root</span>
    </div>
    
    <!-- File Explorer Container -->
    <div id="file-explorer" class="file-explorer">
      <div class="explorer-loading">Loading...</div>
    </div>

    <div style="flex: 1"></div>
    <div style="margin-top: 20px;">
        <a href="{{ url_for('domain_expansion') }}" target="_blank" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">
            Domain Expansion ‚Üó
        </a>
    </div>
  </aside>

  <main>
    <header>
      <div class="question-box">
        <textarea id="question" placeholder="Ask a question about the selected code..."></textarea>
        <button id="ask-btn" disabled>Ask</button>
      </div>
    </header>

    <div class="workspace">
      <!-- Column 1: Chat + Thought Bubble -->
      <div class="col-left">
        <!-- Chat Section (Top 25%) -->
        <div class="chat-panel">
          <div class="chat-header">
            <span>Answer Stream</span>
            <button id="clear-chat" style="background:none; border:none; color:var(--accent-color); cursor:pointer;">Clear</button>
          </div>
          <div class="chat-body" id="chat-container">
            <div style="color: #999; text-align: center; margin-top: 20px;">
              Answers will appear here.
            </div>
          </div>
        </div>

        <!-- Thought Bubble Section (Bottom 75%) -->
        <div class="thought-bubble-panel">
          <div class="tb-header">
            <span>Thought Bubble</span>
            <div class="tb-tools">
                <!-- Only basic manipulation tools for Thought Bubble -->
                <button id="tb-clear" title="Clear Canvas">üóëÔ∏è</button>
                <button id="tb-download" title="Download PNG">üíæ</button>
                <!-- Removed Editing Tools: Draw, Text, Rect, Circle, Note, etc. -->
            </div>
          </div>
          <div class="tb-canvas-container" id="canvas-container">
             <canvas id="thought-bubble-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Column 2: Document Viewer (Middle) -->
      <div class="col-middle">
        <div class="doc-header">
          <span id="pdf-doc-label">No Document Selected</span>
          <div class="pdf-controls">
            <button id="prev-page">‚óÄ</button>
            <span id="page-indicator" contenteditable="true">1</span> / <span id="total-pages">--</span>
            <button id="next-page">‚ñ∂</button>
            <button id="view-pdf-btn" title="View PDF" disabled>View PDF</button>
            <button id="snippet-tool-btn" title="Snippet Tool">‚úÇÔ∏è</button>
          </div>
        </div>
        <div class="doc-body" id="pdf-wrapper">
           <div id="selection-overlay"></div>
           <div id="pdf-render-container">
             <div style="color: #666; margin-top: 50px;">Select a document to view</div>
           </div>
        </div>
      </div>

      <!-- Column 3: Bookmarks & Snippets (Right) -->
      <div class="col-right">
        <!-- Relevant Pages -->
        <div class="bm-section-top">
          <div class="bm-header">Relevant Pages</div>
          <div class="bm-list" id="page-links-list">
             <div style="padding: 10px; color: #666; font-size: 0.9rem;">
                Ask a question to find pages.
             </div>
          </div>
        </div>

        <!-- Saved Snippets / Folders -->
        <div class="bm-section-bottom">
          <div class="bm-header">
             <span>Saved Snippets</span>
             <button id="create-folder-btn" title="New Folder" style="background:none; border:none; color: #fff; cursor: pointer;">üìÇ+</button>
          </div>
          <div style="padding: 5px 10px;">
             <input type="text" id="new-folder-name" placeholder="New Folder Name..." style="width: 100%; background: #333; border: 1px solid #444; color: #ddd; padding: 4px; border-radius: 4px;">
          </div>
          <div class="bm-list" id="bookmarks-container">
             <!-- Populated by bookmarks.js -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Application Scripts -->
  <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
  <script src="{{ url_for('static', filename='js/pdf_viewer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bookmarks.js') }}"></script>
  <script src="{{ url_for('static', filename='js/thought_bubble.js') }}"></script>

  <!-- File Explorer Logic -->
  <script>
    let currentPath = 'Codes/';
    let selectedDocId = null;
    let selectedFileName = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Load root directory on page load
        loadDirectory('Codes/');
    });

    async function loadDirectory(path) {
        const explorer = document.getElementById('file-explorer');
        explorer.innerHTML = '<div class="explorer-loading">Loading...</div>';
        
        try {
            const response = await fetch(`/browse_directory?path=${encodeURIComponent(path)}`);
            const data = await response.json();
            
            currentPath = data.current_path;
            updateBreadcrumb(currentPath);
            renderExplorer(data);
        } catch (error) {
            console.error('Error loading directory:', error);
            explorer.innerHTML = '<div class="explorer-error">Error loading directory</div>';
        }
    }

    function updateBreadcrumb(path) {
        const breadcrumb = document.getElementById('breadcrumb');
        breadcrumb.innerHTML = '';
        
        // Split path into parts (e.g., "pdfs/Category/Year/" -> ["pdfs", "Category", "Year"])
        const parts = path.split('/').filter(p => p);
        
        // Add root
        const rootSpan = document.createElement('span');
        rootSpan.className = 'breadcrumb-item';
        rootSpan.dataset.path = 'Codes/';
        rootSpan.textContent = 'üìÅ Root';
        rootSpan.addEventListener('click', () => loadDirectory('Codes/'));
        breadcrumb.appendChild(rootSpan);
        
        // Add each part
        let accumulatedPath = '';
        for (let i = 0; i < parts.length; i++) {
            if (parts[i] === 'Codes') {
                accumulatedPath = 'Codes/';
                continue;
            }
            
            accumulatedPath += parts[i] + '/';
            
            const separator = document.createElement('span');
            separator.className = 'breadcrumb-separator';
            separator.textContent = ' / ';
            breadcrumb.appendChild(separator);
            
            const partSpan = document.createElement('span');
            partSpan.className = 'breadcrumb-item';
            partSpan.dataset.path = accumulatedPath;
            partSpan.textContent = parts[i];
            
            // Only make it clickable if it's not the last item
            if (i < parts.length - 1) {
                const clickPath = accumulatedPath;
                partSpan.addEventListener('click', () => loadDirectory(clickPath));
            } else {
                partSpan.classList.add('active');
            }
            
            breadcrumb.appendChild(partSpan);
        }
    }

    function renderExplorer(data) {
        const explorer = document.getElementById('file-explorer');
        explorer.innerHTML = '';
        
        // Show folders first
        data.folders.forEach(folder => {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'explorer-item folder';
            folderDiv.innerHTML = `
                <span class="icon">üìÅ</span>
                <span class="name">${folder.name}</span>
            `;
            folderDiv.addEventListener('click', () => loadDirectory(folder.path));
            explorer.appendChild(folderDiv);
        });
        
        // Then show files
        data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'explorer-item file';
            fileDiv.dataset.docId = file.doc_id;
            fileDiv.innerHTML = `
                <span class="icon">üìÑ</span>
                <span class="name">${file.name}</span>
            `;
            fileDiv.addEventListener('click', () => selectDocument(file.doc_id, file.name, fileDiv));
            explorer.appendChild(fileDiv);
        });
        
        // Show empty message if no items
        if (data.folders.length === 0 && data.files.length === 0) {
            explorer.innerHTML = '<div class="explorer-empty">This folder is empty</div>';
        }
    }

    function selectDocument(docId, fileName, element) {
        // Remove previous selection
        document.querySelectorAll('.explorer-item.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Add selection to clicked element
        element.classList.add('selected');
        
        // Store selected doc_id and filename
        selectedDocId = docId;
        selectedFileName = fileName;
        
        // Update the hidden doc_id field for the chat system
        // The chat.js expects a #doc_id element
        let docIdInput = document.getElementById('doc_id');
        if (!docIdInput) {
            // Create a hidden input if it doesn't exist
            docIdInput = document.createElement('input');
            docIdInput.type = 'hidden';
            docIdInput.id = 'doc_id';
            document.body.appendChild(docIdInput);
        }
        docIdInput.value = docId;
        
        // Trigger change event for chat.js compatibility
        const changeEvent = new Event('change');
        docIdInput.dispatchEvent(changeEvent);
        
        // Enable View PDF button
        const viewPdfBtn = document.getElementById('view-pdf-btn');
        if (viewPdfBtn) {
            viewPdfBtn.disabled = false;
        }
        
        console.log('Selected document:', docId);
    }
  </script>
</body>
</html>
