<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Domain Expansion</title>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Overrides for Domain Expansion Mode */
    body {
        background-color: #222;
        color: #eee;
    }
    .workspace {
        height: 100vh;
    }
    .col-left {
        flex: 1; /* Main Canvas Area */
        background: #333;
        border: none;
    }
    .col-right {
        background: #1a1a1a;
        border-left: 1px solid #444;
        color: #ddd;
    }
    /* Hide unneeded modules from Index Layout */
    .chat-panel, .col-middle, aside.left-sidebar {
        display: none !important; 
    }
    
    /* Re-style Thought Bubble container to be full screen */
    .thought-bubble-panel {
        background: #2a2a2a;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .tb-canvas-container {
        flex: 1;
        background-image: radial-gradient(#555 1px, transparent 1px);
        background-size: 20px 20px;
    }
    .bm-header, .folder-header {
        color: #ddd;
        background: #333;
        border-bottom-color: #444;
    }
    .snippet-item {
        background: #333;
        border-color: #444;
        color: #ddd;
    }
    .snippet-item:hover {
        background: #444;
    }
    .bm-section-top { display: none; } /* No page links in this view */
    
    /* Toolbar Styling */
    .tb-header {
        background: #111;
        border-bottom: 1px solid #333;
        color: #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
    }
    .tb-tools {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .tb-tools button {
        background: #444;
        color: #fff;
        border: 1px solid #555;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }
    .tb-tools button:hover { background: #555; }
    .tb-tools button.active { background: var(--accent-color); border-color: var(--accent-color); }
    .divider { width: 1px; height: 20px; background: #555; margin: 0 5px; }
    input[type="color"] {
        width: 30px; height: 30px; padding: 0; border: none; background: none; cursor: pointer;
    }
  </style>
</head>
<body>

  <main>
    <div class="workspace">
      <!-- Full Screen Canvas Area -->
      <div class="col-left">
        <div class="thought-bubble-panel">
          <div class="tb-header">
            <span style="font-weight: bold; font-size: 1.2rem;">Domain Expansion</span>
            <div class="tb-tools">
                <button id="tb-select" title="Select Tool">üëÜ</button>
                <button id="tb-draw" title="Draw">‚úèÔ∏è</button>
                <input type="color" id="tb-draw-color" value="#ffffff" title="Brush Color">
                
                <div class="divider"></div>
                
                <button id="tb-text" title="Add Text">T</button>
                <input type="color" id="tb-text-color" value="#ffffff" title="Text Color">
                
                <button id="tb-rect" title="Add Rectangle">‚¨ú</button>
                <input type="color" id="tb-rect-color" value="#ffff00" title="Rect Color">
                
                <button id="tb-circle" title="Add Circle">‚ö™</button>
                <input type="color" id="tb-circle-color" value="#ffffff" title="Circle Stroke Color">

                <button id="tb-note" title="Add Sticky Note">üìù</button>

                <div class="divider"></div>
                <button id="tb-clear" title="Clear Canvas">üóëÔ∏è</button>
                <button id="tb-download" title="Download PNG">üíæ</button>
                <button id="de-download" title="Export PDF">üìÑ</button>
            </div>
          </div>
          <div class="tb-canvas-container" id="canvas-container">
             <canvas id="thought-bubble-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Bookmarks Side Panel (for Dragging Snippets) -->
      <div class="col-right" style="width: 250px; flex: none;">
        <div class="bm-section-bottom" style="height: 100%; border-top: none;">
          <div class="bm-header">
             <span>Snippet Library</span>
          </div>
          <div class="bm-list" id="bookmarks-container" style="height: calc(100% - 40px);">
             <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Re-use our centralized logic -->
  <script src="{{ url_for('static', filename='js/thought_bubble.js') }}"></script>

  <script>
    // Simplified Bookmarks Loader for Domain Expansion
    // Reads from localStorage to display available snippets to drag onto canvas
    const BookmarksLoader = (() => {
        const container = document.getElementById('bookmarks-container');
        let bookmarks = [];

        function init() {
            loadFromStorage();
            render();
        }

        function loadFromStorage() {
            try {
                bookmarks = JSON.parse(localStorage.getItem('rag_bookmarks') || '[]');
            } catch(e) {}
        }

        function render() {
            container.innerHTML = '';
            if (bookmarks.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:#666;">No snippets found. Go back to main workspace to create some.</div>';
                return;
            }

            bookmarks.forEach(item => {
                if (item.type === 'folder') {
                    renderFolder(item);
                } else {
                    renderSnippet(item);
                }
            });
        }

        function renderFolder(folder) {
            const el = document.createElement('div');
            el.className = 'folder-item';
            el.innerHTML = `
                <div class="folder-header" style="padding:8px; cursor:pointer;">
                    <span>üìÅ ${folder.name}</span>
                </div>
                <div class="folder-content" style="padding-left:10px;"></div>
            `;
            const content = el.querySelector('.folder-content');
            folder.children.forEach(child => {
                content.appendChild(renderSnippet(child, false));
            });
            container.appendChild(el);
        }

        function renderSnippet(snippet, append=true) {
            const el = document.createElement('div');
            el.className = 'snippet-item';
            el.style.padding = '8px';
            el.style.borderBottom = '1px solid #444';
            el.style.cursor = 'pointer';
            el.textContent = snippet.name;
            
            // Clicking adds it to canvas
            el.onclick = () => {
                window.dispatchEvent(new CustomEvent('add-to-canvas', { detail: snippet }));
            };
            
            if (append) container.appendChild(el);
            return el;
        }

        return { init };
    })();

    document.addEventListener('DOMContentLoaded', BookmarksLoader.init);
  </script>
</body>
</html>
